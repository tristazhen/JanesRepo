<!--********************************************************************
* Copyright© 2000 - 2020 SuperMap Software Co.Ltd. All rights reserved.
*********************************************************************-->
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title data-i18n="resources.title_iPortalQueryMyResources"></title>
    <style>
    .gallery-item {
        margin-bottom: 30px;
    }
    .gallery-item-border {
        border: 1px solid #dadada;
        -webkit-box-shadow: 0px 2px 3px #dcdcdc;
        box-shadow: 0px 2px 3px #dcdcdc;
        background: white;
    }
    .thumbnail > img, .thumbnail a > img {
        margin-right: auto;
        margin-left: auto;
    }
    .gallery-item-img {
        height: 170px !important;
        width: 262px !important;
    }
    .resourcesDetails {
        height: 21px;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
        font-size: 14px !important;
        color: #7c7c7c;
    }
    .resourcesDetails a {
        display: block;
        margin-right: 12px;
    }
    .title-checkbox-container p{
        max-width: 150px;
        float: left;
    }
    .title-checkbox-container input{
        float: right;
    }
    .operate-btn-container , .title-checkbox-container{
        width: 100%;
        height: 33px;
        padding: 0 17px;
    }
    .operate-btn-container a:nth-child(1){
        float: left;
    }
    .operate-btn-container a:nth-child(2){
        float: right;
    }
    #plottingPanel {
        float: left;
        background: #ffffff;
        width: 250px;
        height: 100%;
        border: 1px solid #3473b7;
    }
    .datagrid-cell {
        word-break: break-all;
        white-space: normal!important;
    }
    .tabs-container ,.tabs-panels,.panel-body{
        height: auto!important;
    }
    .panel-title {
        margin-top: 0!important;
        margin-bottom: 0!important;
        font-size: 16px!important;
        color: inherit!important;
    }
    #login-btn {
        display:none;
        text-align: center;
        position: absolute;
        left: 50%;
        top: 50%;
        margin-left: 64px;
    }
    </style>
</head>
<body style=" margin: 0;overflow: auto;background: #F2F2F2;width: 100%;height:100%;position: absolute;top: 0;">
    <!-- 登录按钮 -->
    <input type="button" class="btn btn-default" data-i18n="[value]resources.text_login" id="login-btn" onclick="showLoginModel()">
    <!-- 登录模态框（Modal） -->
    <div class="modal fade" id="loginModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal" aria-hidden="true">
                        &times;
                    </button>
                    <h4 class="modal-title" id="myModalLabel" data-i18n="resources.text_login"></h4>
                </div>
                    <table class="table table-bordered col-md-6">
                        <tbody>
                        <!--token 申请-->
                        <tr>
                            <td>
                                <div class="col-md-10 col-md-offset-1">
                                    <form class="form-horizontal">
                                        <fieldset>
                                            <div class="form-group">
                                                <label for="username_iportal" class="col-md-2 control-label" style="width:26.666667%;" data-i18n="resources.title_resource_address"></label>
            
                                                <div class="col-md-8">
                                                    <input type="text" class="form-control" id="resource_address" >
                                                </div>
                                            </div>
                                            <div class="form-group">
                                                <label for="username_iportal" class="col-md-2 control-label" data-i18n="resources.text_userName" style="width:26.666667%;"></label>
            
                                                <div class="col-md-8">
                                                    <input type="text" class="form-control" id="username_iportal">
                                                </div>
                                            </div>
                                            <div class="form-group">
                                                <label for="password_iportal" class="col-md-2 control-label" data-i18n="resources.text_password" style="width:26.666667%;"></label>
            
                                                <div class="col-md-8">
                                                    <input type="password" class="form-control" id="password_iportal">
                                                </div>
                                            </div>
                                        </fieldset>
                                    </form>
                                </div>
                            </td>
                        </tr>
                        </tbody>
                    </table>
                <div class="modal-footer">
                    <button type="button" class="btn btn-default" data-dismiss="modal" onclick="getDefaultUrl()" data-i18n="resources.text_close">
                    </button>
                    <button type="button" class="btn btn-primary" onclick="generatePortalToken()" data-i18n="resources.text_confirm">
                    </button>
                </div>
            </div><!-- /.modal-content -->
        </div><!-- /.modal -->
    </div>
    <!-- 删除资源模态框（Modal） -->
    <div class="modal fade" tabindex="-1" role="dialog" id="deleteModel">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                    <h4 class="modal-title" data-i18n="resources.title_delete_resources"></h4>
                </div>
                <div class="modal-body">
                    <p data-i18n="resources.title_confirm_delete_resources"></p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-default" data-dismiss="modal" data-i18n="resources.text_close"></button>
                    <button type="button" class="btn btn-primary" onclick="requestDeleteUrl()" data-i18n="resources.text_confirm"></button>
                </div>
            </div>
        </div>
    </div>
    <!-- 共享资源模态框（Modal） -->
    <div class="modal fade" id="shareModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <div class="modal-header">
                        <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                        <h4 class="modal-title" data-i18n="resources.title_share_setting"></h4>
                    </div>
                </div>
                    <table class="table table-bordered col-md-6">
                        <tbody>
                        <!--共享设置-->
                        <tr>
                            <td>
                                <div class="col-md-10 col-md-offset-1">
                                    <form class="form-horizontal">
                                        <fieldset>
                                                <ul class="nav nav-tabs" role="tablist">
                                                    <li role="presentation" class="active">
                                                        <a href="#public" aria-controls="public" role="tab" data-toggle="tab" data-i18n="resources.title_iPortalQueryResourcesPublic"></a>
                                                    </li>
                                                </ul>
                                                <div class="tab-content">
                                                    <div role="tabpanel" class="tab-pane active" id="public">
                                                        
                                                    </div>
                                                </div>
                                        </fieldset>
                                    </form>
                                </div>
                            </td>
                        </tr>
                        </tbody>
                    </table>
                <div class="modal-footer">
                    <button type="button" class="btn btn-default" data-dismiss="modal" data-i18n="resources.text_close">
                    </button>
                    <button type="button" class="btn btn-primary" onclick="requestShareUrl()" data-i18n="resources.btn_save">
                    </button>
                </div>
            </div>
        </div>
    </div>
    <!-- 详情 属性面板Dom -->
    <div id="plottingPanel">
        <div class="easyui-panel" style="position:absolute;top:0px;bottom:0px;left:0px;right:0px;padding:5px; width: 100%;">
            <div class="easyui-tabs" style="width: 100%;height: 100%" id="edit-and-detail-plot">
                <div id="iPortalDetailPanel" data-i18n="[title]resources.text_detailPanel" style="overflow: hidden"></div>
                <div id="plotPanel" data-i18n="[title]resources.text_attributePanel" style="overflow: hidden"></div>
            </div>
        </div>
    </div>
    <!-- 资源过滤 and 资源展示 -->
    <div class="container" style="margin-bottom: 100px">
        <div id="toolbar" class="panel panel-primary" style="position: absolute;top: 10px;right: 70px;text-align: center;z-index: 800;border-radius: 4px;">
            <div class='panel-heading' id="panelheading">
                <h5 class='panel-title text-center' data-i18n="resources.title_iPortalQueryMyResources"></h5>
            </div>
            <div class='panel-body content' id="panelbodycontent">
                <!-- 资源类型选择 -->
                <div class='input-group' style="width: 220px">
                    <span class='input-group-addon' data-i18n="resources.title_iPortalQueryResourcesType"></span>
                    <select class='form-control' id='typeSelect' onchange="onSelectResourcesType()">
                        <option value="MAP" data-i18n="resources.title_iPortalQueryResourcesMap"></option>
                        <option value="SERVICE" data-i18n="resources.title_iPortalQueryResourcesService"></option>
                        <option value="SCENE" data-i18n="resources.title_iPortalQueryResourcesScene"></option>
                        <option value="DATA" data-i18n="resources.title_iPortalQueryResourcesData"></option>
                        <option value="INSIGHTS_WORKSPACE" data-i18n="resources.title_iPortalQueryResourcesInsights"></option>
                        <option value="MAP_DASHBOARD" data-i18n="resources.title_iPortalQueryResourcesDashboards"></option>
                    </select>
                </div>
            </div>
        </div>
        <br />
        <div class="col-md-10">
            <div class="row">
                <div class="col-md-12">
                    <div class="operate-list">
                        <input type='button' class="btn btn-default" onclick="deleteResource()" data-i18n="[value]resources.text_input_value_delete"/>
                        <input type='button' class="btn btn-default" onclick="shareResource()" data-i18n="[value]resources.title_share_setting"/>
                    </div>
                    <!--所有资源的承载DIV-->
                    <div class="row" id="resourcesList">
                        <!--单个资源数据的可视化承载DIV 添加在此位置中-->
                    </div>
                </div>
            </div>
        </div>
    </div>
<script type="text/javascript" include="jquery,bootstrap,plottingPanel,widgets" src="../js/include-web.js"></script>
<script type="text/javascript" include="iclient-plot-leaflet" src="../../dist/leaflet/include-leaflet.js"></script>
<script type="text/javascript" include="iPortalStylePanel" src="../js/plottingPanel/PlottingPanel.Include.js"></script>
<script>
    //iportal的URL地址 或根据情况添加自己的本地iportal地址：http://localhost:8091/iportal
    var iPortalUrl = "https://iportal.supermap.io/iportal";
    //默认请求资源类型
    var resourceType = "MAP";
    //全局变量，承载请求后，一共有多少页数
    var queryParams = new SuperMap.iPortalQueryParam({
        resourceType: resourceType,
        pageSize: 15,
        currentPage: 1,
        searchType:'MY_RES'
    });
    //资源查询初始化工作
    var iPortal;
    var isShowLogin = true;
    var deleteIds = [];//批量删除id
    var shareIds = [];//批量共享设置id
    var itemData = {};//某条资源的详细信息
    //共享设置
    var publicSettingEntity = {
        "permissionType": "",
        "entityType": "USER",
        "entityName": "GUEST",
        "entityId": null,
        "authorizeList": []
    }
    $(document).ready(function () {
        $("#loginModal").modal();
        $("#resource_address").attr("value",iPortalUrl)
    });
    function getDefaultUrl(){
        iPortal = new SuperMap.iPortal(iPortalUrl);
    }
    function showLoginModel (){
        $("#loginModal").modal("show");
    }
    // 申请，注册token并查询
    function generatePortalToken() {
        var resourceAddress = $("#resource_address").val();
        var serverInfo = new SuperMap.ServerInfo(SuperMap.ServerType.IPORTAL, {
            server: resourceAddress
        });

        SuperMap.SecurityManager.registerServers([serverInfo]);
        var userName = $('#username_iportal').val();
        var password = $('#password_iportal').val();
        var clientType = "NONE";
        var referer = "";
        var expiration = "1440"; // 过期时间1440分钟，即一天

        SuperMap.SecurityManager.generateToken(resourceAddress, new SuperMap.TokenServiceParameter({
            userName: userName,
            password: password,
            clientType: clientType,
            referer: referer,
            ip: referer,
            expiration: expiration
        })).then(function (result) {
            if(result.indexOf("succeed") === -1) {
                SuperMap.SecurityManager.destroyToken(resourceAddress);
                SuperMap.SecurityManager.registerToken(resourceAddress, result);
                // todo
                $("#loginModal").modal("hide");
                iPortalUrl = resourceAddress;
                //加载完DOM后，开始资源数据查询并添加
                iPortal = new SuperMap.iPortal(iPortalUrl);
                queryResouces(queryParams);
            } else {
                iPortal = new SuperMap.iPortal(iPortalUrl);
                widgets.alert.showAlert(resources.msg_login_failed, false);
            }
        });
    }

    // 查询iPortal中的资源
    function queryResouces(queryParams) {
        iPortal.queryResources(queryParams).then(function (resourcesReslut) {
            $("#login-btn").css("display","none");
            //返回的结果集，需要查看可打开下行代码
            // console.log(resourcesReslut);
            // 切换资源类型 清空之前的资源DOM
            $("#resourcesList").children().remove();
            //将结果集进行遍历，并添加到HTML中
            $.each(resourcesReslut.content, function (i) {
                var resourceItem = resourcesReslut.content[i];
                var thumbnail = resourceItem.thumbnail;
                // 此判断获取部分相对路径的default图片
                if(thumbnail.indexOf("./") === 0){
                    thumbnail = iPortalUrl + thumbnail;
                }
                var resourcesDOM = $("<div class='col-md-4 gallery-item' id='map'>" +
                    "<div class='gallery-item-border'>" +
                    "<a class='thumbnail' style='margin-bottom: 10px'>" +
                    "<img  class='gallery-item-img' src='" + thumbnail + "' alt=''>" +
                    "</a>" +
                    "<div>" +
                    "<div class='title-checkbox-container'>"+
                        "<p class='resourcesDetails'>" + resourceItem.name + "</p>" +
                        "<input type='checkbox' class='floatLeft' id='preferenceCheck' name='checkbox' value='"+resourceItem.resourceId+"'/>" +
                    "</div>"+
                    "<div>" +
                        "<div class='operate-btn-container'>"+
                                "<a href='#' class='delete' onclick='deleteResource("+resourceItem.resourceId +")'>"+resources.text_input_value_delete+"</a>" +
                                "<a href='#' id='detail' onclick='viewResource("+resourceItem.resourceId+")'>"+resources.title_view_detail+"</a>"+
                        "</div>"+
                        "<div class='operate-btn-container'>"+
                            "<a href='#' class='edit' onclick='editResource("+resourceItem.resourceId+","+resourceItem.resourceId+")'>"+resources.title_edit_attr+"</a>"+
                            "<a href='#' class='edit' onclick='shareResource("+resourceItem.resourceId+")'>"+resources.title_share_setting+"</a>"+
                        "</div>"+
                    "</div>" +
                    "</div>")
                $("#resourcesList").append(resourcesDOM);
            });
        }).catch (()=>{
            $("#login-btn").css("display","block");
            widgets.alert.showAlert(resources.msg_query_failed, false);

        })
    };

    //获取多选CheckBox资源的id值 给（删除 和 共享资源 使用）
    function getDeleteAndShareCheckArr(){
        var checkDataEle = document.getElementsByName("checkbox");
        var check_val = [];
        for(k in checkDataEle) {
            if(checkDataEle[k].checked){
                check_val.push(checkDataEle[k].value);
            }
        }
        return check_val;
    }

    //删除资源代码块
    //点击删除前 确认弹框
    function deleteResource(ids){
        deleteIds = ids ? [ids] : getDeleteAndShareCheckArr();
        if(deleteIds.length<=0) {
            widgets.alert.showAlert(resources.msg_choise_resources_delete, false);
        }else {
            $('#deleteModel').modal('show');
        }
    }
    //发送删除请求
    function requestDeleteUrl(){
        var resourceIds = deleteIds;
        var deleteParams = {
            resourceType: resourceType,
            ids: resourceIds
        };
        new SuperMap.iPortalUser(iPortalUrl).deleteResources(deleteParams).then(result=>{
            $('#deleteModel').modal('hide');
            widgets.alert.showAlert(resources.text_deleteSuccess, true);
            deleteIds = [];
        }).catch(err => {
            widgets.alert.showAlert(resources.msg_deleteFailure, false);
        })
    }

    //编辑资源属性参数对象
    var attributes = {
        title: '',
        tags: [''],
        description: '',
        tokenRefreshUrl: '',
        refSysInfo: {
            refSysID: 0,
            projection: ''
        },
        identifier: {
            region:''
        },
        bounds: {
            west:0.0,
            east:0.0,
            south:0.0,
            north:0.0
        },
        contact: {
            personName: '',
            orgName: '',
            address: '',
            email: '',
            voiceNum: '',
            faxNum:''
        },
        dataMetaInfo: {},
        filePostfix: ''
    }
    //点击查看详情按钮
    function viewResource(ids){
        $("#edit-and-detail-plot").tabs('select',0);
        var item = new SuperMap.iPortalResource(iPortalUrl,{resourceId:ids,resourceType:resourceType});
        item.load().then(()=>{
            //创建详情面板
            L.supermap.plotting.initIportalStylePanel("iPortalDetailPanel",resourceType,item.sourceJSON,'detail');
        });
    }
    //点击编辑属性按钮
    function editResource(ids){
        viewResource(ids)
        $("#edit-and-detail-plot").tabs('select',1);
        var item = new SuperMap.iPortalResource(iPortalUrl,{resourceId:ids,resourceType:resourceType});
        item.load().then(()=>{
            //创建属性面板 
            L.supermap.plotting.initIportalStylePanel("plotPanel", resourceType, item.sourceJSON,'edit');
            itemData = item.sourceJSON;
            //填充attributes对象
            switch (resourceType) {
                case 'MAP':
                    attributes.title = itemData.title!=null?itemData.title:'';
                    break;
                case 'SERVICE':
                    attributes.title = itemData.resTitle!=null?itemData.resTitle:'';
                    attributes.tokenRefreshUrl = itemData.tokenRefreshUrl!=null?itemData.tokenRefreshUrl:'';
                    attributes.refSysInfo.refSysID = itemData.metadata.refSysInfo!=null?itemData.metadata.refSysInfo.refSysID:'';
                    attributes.refSysInfo.projection = itemData.metadata.refSysInfo!=null?itemData.metadata.refSysInfo.mdCoRefSys.projection:'';
                    attributes.identifier.region = itemData.metadata.dataIdInfo!=null?itemData.metadata.dataIdInfo.dataIdent.dataExt.exDesc:'';
                    attributes.bounds.west = itemData.metadata.dataIdInfo!=null?itemData.metadata.dataIdInfo.dataIdent.dataExt.geoEle.geoBndBox.westBL:'';
                    attributes.bounds.east = itemData.metadata.dataIdInfo!=null?itemData.metadata.dataIdInfo.dataIdent.dataExt.geoEle.geoBndBox.eastBL:'';
                    attributes.bounds.south = itemData.metadata.dataIdInfo!=null?itemData.metadata.dataIdInfo.dataIdent.dataExt.geoEle.geoBndBox.southBL:'';
                    attributes.bounds.north = itemData.metadata.dataIdInfo!=null?itemData.metadata.dataIdInfo.dataIdent.dataExt.geoEle.geoBndBox.northBL:'';
                    attributes.contact.personName = itemData.metadata.mdContact!=null?itemData.metadata.mdContact.rpIndName:'';
                    attributes.contact.orgName = itemData.metadata.mdContact!=null?itemData.metadata.mdContact.rpOrgName:'';
                    attributes.contact.address = itemData.metadata.mdContact!=null?itemData.metadata.mdContact.rpCntInfo.cntAddress.delPoint:'';
                    attributes.contact.email = itemData.metadata.mdContact!=null?itemData.metadata.mdContact.rpCntInfo.cntAddress.EMailAdd:'';
                    attributes.contact.voiceNum = itemData.metadata.mdContact!=null?itemData.metadata.mdContact.rpCntInfo.voiceNum:'';
                    attributes.contact.faxNum = itemData.metadata.mdContact!=null?itemData.metadata.mdContact.rpCntInfo.faxNum:'';
                    break;
                case 'SCENE':
                    attributes.title = itemData.name!=null?itemData.name:'';
                    break
                case 'DATA':
                    attributes.title = itemData.fileName!=null?itemData.fileName.substring(0,itemData.fileName.lastIndexOf(".")):'';
                    attributes.filePostfix = itemData.fileName!=null?itemData.fileName.substr(itemData.fileName.lastIndexOf(".")):'';
                    attributes.dataMetaInfo = itemData.dataMetaInfo!=null?itemData.dataMetaInfo:{};
                    break;
                case 'INSIGHTS_WORKSPACE':
                    attributes.title = itemData.name!=null?itemData.name:'';
                    break;
                case 'MAP_DASHBOARD':
                    attributes.title = itemData.name!=null?itemData.name:'';
                    break;
            }
            attributes.tags = itemData.tags!=null?itemData.tags.join(" "):[];
            attributes.description = itemData.description!=null?itemData.description:'';
        });
    }
    //修改表格属性值后 则会立刻调用此函数 {rowIndex:改变属性的数据索引 rowData:改变属性后的数据对象 changes:改变的属性值}
    function afterModifySelectFeature(rowIndex, rowData, changes){
        if(rowData.length !== 0 ){
            new Promise(() => {
                if(rowData.length !== 0) {
                    updateSelectFeature(rowData,itemData);
                }
                return;
            })
        }
    }
    //调用资源update接口，模拟服务metadata对象（所有字段） 提交后端 防止因为后端返回metadata对象为空 造成属性提交报错的问题（如果有变化 就替换 否则提交默认值）
    var entity = {
        metadata: {
            dataIdInfo: {
                dataIdent: {
                    idCitation: {
                        resTitle: ""
                    },
                    idAbs: "",
                    dataExt: {
                        exDesc: "",
                        geoEle: {
                            geoBndBox: {
                                westBL: "",
                                eastBL: "",
                                southBL: "",
                                northBL: "",
                            },
                        },
                    },
                },
            },
            refSysInfo: {
                refSysID: "",
                mdCoRefSys: {
                    projection: ""
                }
            },
            mdContact: {
                rpIndName: "",
                rpOrgName: "",
                rpCntInfo: {
                    cntAddress: {
                        delPoint: "",
                        EMailAdd: ""
                    },
                    voiceNum: "",
                    faxNum: ""
                }
            }
        },
    }
    //构造属性对象 提交参数 更改属性值
    function updateSelectFeature(updated,data) {
        switch (updated.key){
            case "title":
                if(attributes.title === updated.value) {
                    return;
                }
                attributes.title = updated.value;
                break;
            case "tags":
                if(attributes.tags === updated.value) {
                    return;
                }
                attributes.tags = updated.value.split(",");
                break;
            case "description":
                if(attributes.description === updated.value) {
                    return;
                }
                attributes.description = updated.value;
                break;
            case "tokenRefreshUrl":
                if(attributes.tokenRefreshUrl === updated.value) {
                    return;
                }
                attributes.tokenRefreshUrl = updated.value;
                break;
            case "refSysID":
                if(attributes.refSysInfo.refSysID === updated.value) {
                    return;
                }
                attributes.refSysInfo.refSysID = updated.value;
                break;
            case "projection":
                if(attributes.refSysInfo.projection === updated.value) {
                    return;
                }
                attributes.refSysInfo.projection = updated.value;
                break;
            case "region":
                if(attributes.identifier.region === updated.value) {
                    return;
                }
                attributes.identifier.region = updated.value;
                break;
            case "west":
                if(attributes.bounds.west === updated.value) {
                    return;
                }
                attributes.bounds.west = updated.value;
                break;
            case "east":
                if(attributes.bounds.east === updated.value) {
                    return;
                }
                attributes.bounds.east = updated.value;
                break;
            case "south":
                if(attributes.bounds.south === updated.value) {
                    return;
                }
                attributes.bounds.south = updated.value;
                break;
            case "north":
                if(attributes.bounds.north === updated.value) {
                    return;
                }
                attributes.bounds.north = updated.value;
                break;
            case "personName":
                if(attributes.contact.personName === updated.value) {
                    return;
                }
                attributes.contact.personName = updated.value;
                break;
            case "orgName":
                if(attributes.contact.orgName === updated.value) {
                    return;
                }
                attributes.contact.orgName = updated.value;
                break;
            case "address":
                if(attributes.contact.address === updated.value) {
                    return;
                }
                attributes.contact.address = updated.value;
                break;
            case "email":
                if(attributes.contact.email === updated.value) {
                    return;
                }
                attributes.contact.email = updated.value;
                break;
            case "voiceNum":
                if(attributes.contact.voiceNum === updated.value) {
                    return;
                }
                attributes.contact.voiceNum = updated.value;
                break;
            case "faxNum":
                if(attributes.contact.faxNum === updated.value) {
                    return;
                }
                attributes.contact.faxNum = updated.value;
                break;
            
            case "bounds":
                if(attributes.dataMetaInfo) {
                    var bounds = attributes.dataMetaInfo.bounds!=null?attributes.dataMetaInfo.bounds:'';
                    if(bounds === updated.value) {
                        return;
                    }
                }
                attributes.dataMetaInfo.bounds = updated.value;
                break;
            case "epsgCode":
                if(attributes.dataMetaInfo) {
                    var epsgCode = attributes.dataMetaInfo.epsgCode!=null?attributes.dataMetaInfo.epsgCode:'';
                    if(epsgCode === updated.value) {
                        return;
                    }
                }
                attributes.dataMetaInfo.epsgCode = updated.value;
                break;
            case "previewURL":
                if(attributes.dataMetaInfo) {
                    var previewURL = attributes.dataMetaInfo.previewURL!=null?attributes.dataMetaInfo.previewURL:'';
                    if( previewURL=== updated.value) {
                        return;
                    }
                }
                attributes.dataMetaInfo.previewURL = updated.value;
                break;
            case "providers":
                if(attributes.dataMetaInfo) {
                    var providers = attributes.dataMetaInfo.providers!=null?attributes.dataMetaInfo.providers:'';
                    if(providers === updated.value) {
                        return;
                    }
                }
                attributes.dataMetaInfo.providers = updated.value;
                break;
        }
        var item = new SuperMap.iPortalResource(iPortalUrl,{resourceId:data.id,resourceType:resourceType});
        item.load().then(()=>{
            switch (resourceType) {
                case 'MAP':
                    item.sourceJSON.title = attributes.title;
                    break;
                case 'SERVICE':
                    entity.metadata.dataIdInfo.dataIdent.idCitation.resTitle = attributes.title;
                    item.sourceJSON.tokenRefreshUrl = attributes.tokenRefreshUrl;
                    entity.metadata.refSysInfo.refSysID = attributes.refSysInfo.refSysID;
                    entity.metadata.refSysInfo.mdCoRefSys.projection = attributes.refSysInfo.projection;
                    entity.metadata.dataIdInfo.dataIdent.dataExt.exDesc = attributes.identifier.region;
                    entity.metadata.dataIdInfo.dataIdent.dataExt.geoEle.geoBndBox.westBL = attributes.bounds.west;
                    entity.metadata.dataIdInfo.dataIdent.dataExt.geoEle.geoBndBox.eastBL = attributes.bounds.east;
                    entity.metadata.dataIdInfo.dataIdent.dataExt.geoEle.geoBndBox.southBL = attributes.bounds.south;
                    entity.metadata.dataIdInfo.dataIdent.dataExt.geoEle.geoBndBox.northBL = attributes.bounds.north;
                    entity.metadata.mdContact.rpIndName = attributes.contact.personName;
                    entity.metadata.mdContact.rpOrgName = attributes.contact.orgName;
                    entity.metadata.mdContact.rpCntInfo.cntAddress.delPoint = attributes.contact.address;
                    entity.metadata.mdContact.rpCntInfo.cntAddress.EMailAdd = attributes.contact.email;
                    entity.metadata.mdContact.rpCntInfo.voiceNum = attributes.contact.voiceNum;
                    entity.metadata.mdContact.rpCntInfo.faxNum = attributes.contact.faxNum;
                    item.sourceJSON.metadata =  entity.metadata;
                    break;
                case "DATA":
                    item.sourceJSON.fileName = attributes.title + attributes.filePostfix;
                    item.sourceJSON.dataMetaInfo = attributes.dataMetaInfo;
                    break
                case "SCENE":
                    item.sourceJSON.name = attributes.title;
                    break;
                case "INSIGHTS_WORKSPACE":
                    item.sourceJSON.name = attributes.title;
                    break;
                case "MAP_DASHBOARD":
                    item.sourceJSON.name = attributes.title;
                    break;
            }
            item.sourceJSON.tags = attributes.tags;
            item.sourceJSON.description = attributes.description;
            item.update().then(res => {
                if(res.succeed) {
                    widgets.alert.showAlert(resources.msg_updateSuccess, true);
                }else {
                    widgets.alert.showAlert(resources.msg_updateFailure+","+res.error.errorMsg, false);
                }
            }).catch(()=>{
            });
        })
    }
    
    //共享设置代码块    
    //点击共享设置前 确认弹框
    function shareResource(ids){
        shareIds = ids ? [ids] : getDeleteAndShareCheckArr();
        if(shareIds.length<=0) {
            widgets.alert.showAlert("请选择要共享的资源。", false);
            return;
        }
        $("#public").empty();
        //公开
        if(resourceType === 'MAP') {
            sharePublicDOM = $("<div class='col-md-4 gallery-item' id='shareCheckboxs'>" +
                "<div class='publicPane sub-font' id='search'>" +
                    "<input type='checkbox'" +
                        "value='search'" +
                        "onclick='clickSearchCheckBox()'"+
                    "/>" +
                    "&nbsp; <span>所有用户可检索</span>" +
                "</div>" +
                "<div class='publicPane sub-font' id='view'>" +
                    "<input type='checkbox'" +
                        "value='view'" +
                        "onclick='clickViewCheckBox()'"+
                    "/>" +
                    "&nbsp; <span>所有用户可查看</span>" +
                "</div>" +
                "<div class='publicPane sub-font' id='edit'>" +
                    "<input type='checkbox'" +
                        "value='edit'" +
                        "onclick='clickEditCheckBox()'"+
                    "/>" +
                    "&nbsp; <span>所有用户可编辑（仅限登录用户）</span>" +
                "</div>" +
            "</div>")
        }else if(resourceType === 'SERVICE') {
            sharePublicDOM = $("<div class='col-md-4 gallery-item' id='shareCheckboxs'>" +
                "<div class='publicPane sub-font' id='search'>" +
                    "<input type='checkbox'" +
                        "value='search'" +
                        "onclick='clickSearchCheckBox()'"+
                    "/>" +
                    "&nbsp; <span>所有用户可检索</span>" +
                "</div>" +
                "<div class='publicPane sub-font' id='view'>" +
                    "<input type='checkbox'" +
                        "value='view'" +
                        "onclick='clickViewCheckBox()'"+
                    "/>" +
                    "&nbsp; <span>所有用户可查看</span>" +
                "</div>" +
            "</div>")
        }else if(resourceType === 'SCENE') {
            sharePublicDOM = $("<div class='col-md-4 gallery-item' id='shareCheckboxs'>" +
                "<div class='publicPane sub-font' id='search'>" +
                    "<input type='checkbox'" +
                        "value='search'" +
                        "onclick='clickSearchCheckBox()'"+
                    "/>" +
                    "&nbsp; <span>所有用户可检索</span>" +
                "</div>" +
                "<div class='publicPane sub-font' id='view'>" +
                    "<input type='checkbox'" +
                        "value='view'" +
                        "onclick='clickViewCheckBox()'"+
                    "/>" +
                    "&nbsp; <span>所有用户可查看</span>" +
                "</div>" +
            "</div>")
        }else if(resourceType === 'DATA') {
            sharePublicDOM = $("<div class='col-md-4 gallery-item' id='shareCheckboxs'>" +
                "<div class='publicPane sub-font' id='search'>" +
                    "<input type='checkbox'" +
                        "value='search'" +
                        "onclick='clickSearchCheckBox()'"+
                    "/>" +
                    "&nbsp; <span>所有用户可检索</span>" +
                "</div>" +
                "<div class='publicPane sub-font' id='download'>" +
                    "<input type='checkbox'" +
                        "value='download'" +
                        "onclick='clickDownloadCheckBox()'"+
                    "/>" +
                    "&nbsp; <span>所有用户可下载</span>" +
                "</div>" +
            "</div>")
        }else if(resourceType === 'INSIGHTS_WORKSPACE') {
            sharePublicDOM = $("<div class='col-md-4 gallery-item' id='shareCheckboxs'>" +
                "<div class='publicPane sub-font' id='search'>" +
                    "<input type='checkbox'" +
                        "value='search'" +
                        "onclick='clickSearchCheckBox()'"+
                    "/>" +
                    "&nbsp; <span>所有用户可检索</span>" +
                "</div>" +
                "<div class='publicPane sub-font' id='view'>" +
                    "<input type='checkbox'" +
                        "value='view'" +
                        "onclick='clickViewCheckBox()'"+
                    "/>" +
                    "&nbsp; <span>所有用户可查看</span>" +
                "</div>" +
            "</div>")
        }else if(resourceType === 'MAP_DASHBOARD') {
            sharePublicDOM = $("<div class='col-md-4 gallery-item' id='shareCheckboxs'>" +
                "<div class='publicPane sub-font' id='search'>" +
                    "<input type='checkbox'" +
                        "value='search'" +
                        "onclick='clickSearchCheckBox()'"+
                    "/>" +
                    "&nbsp; <span>所有用户可检索</span>" +
                "</div>" +
                "<div class='publicPane sub-font' id='view'>" +
                    "<input type='checkbox'" +
                        "value='view'" +
                        "onclick='clickViewCheckBox()'"+
                    "/>" +
                    "&nbsp; <span>所有用户可查看</span>" +
                "</div>" +
            "</div>")
        }
        $("#public").append(sharePublicDOM)
        var item = new SuperMap.iPortalResource(iPortalUrl,{resourceId:shareIds[0],resourceType:resourceType});
        item.load().then(()=>{
            if(item.sourceJSON.authorizeSetting && item.sourceJSON.authorizeSetting.length > 0){
                for(let entity of item.sourceJSON.authorizeSetting){
                    let permissionType = entity.permissionType || entity.dataPermissionType;
                    switch(entity.entityType) {
                        case "USER":
                            if(entity.entityName === "GUEST") {
                                //为其增加一权限属性，用于处理复选框数据双向绑定
                                var entityObj = Object.assign({},entity);
                                entityObj["authorizeList"] = getAuthorizeList(permissionType);
                                publicSettingEntity = entityObj;
                            }
                            break;
                    }
                }
            }
            $('#shareModal').modal('show');
            publicSettingEntity.authorizeList.forEach((authorizeListItem,index)=>{
                $("input[value='"+authorizeListItem+"']").prop("checked", true);
            })
        })
    }
    //发送共享设置请求
    function requestShareUrl(){
        var resourceIds = shareIds;
        var entities = getShareEntities();
        queryShareParams = new SuperMap.iPortalShareParam({
            ids:resourceIds,
            entities:entities,
            resourceType:resourceType
        });
        iPortal.updateResourcesShareSetting(queryShareParams).then(result=>{
            $('#shareModal').modal('hide');
            widgets.alert.showAlert(resources.msg_shareSuccess, true);
        }).catch(err => {
            widgets.alert.showAlert(resources.msg_shareFailed, false);
        })
    }
    function getShareEntities(){
        shareSettingList = [];
        //公开
        addSettingEntity(publicSettingEntity);
        return shareSettingList;
    }
    //生成分享的entities参数
    function addSettingEntity(obj){
        var settingEntity =  dealShareSettingParam(obj);
        if(settingEntity){
            shareSettingList.push(settingEntity);
        }
    }
    function dealShareSettingParam(obj) {
        var authorize = "";
        if(!obj.authorizeList){
            return null;
        }
        if(obj.authorizeList.includes("edit")){
            authorize = "READWRITE";
        }else if(obj.authorizeList.includes("view")){
            authorize =  "READ";
        }else if(obj.authorizeList.includes("download")){
            authorize =  "DOWNLOAD";
        }else if(obj.authorizeList.includes("search")){
            authorize = "SEARCH";
        }
        if(authorize){
            if(resourceType === "data") {
                obj.dataPermissionType = authorize;
            }
            obj.permissionType = authorize;
            let targetPermissionEntity  = Object.assign({},obj);
            delete targetPermissionEntity.authorizeList;
            delete targetPermissionEntity.aliasName;
            delete targetPermissionEntity.entityRoles;
            return targetPermissionEntity;
        }else {
            return null;
        }
    }
    function clickSearchCheckBox(){
        if(!publicSettingEntity.authorizeList || (publicSettingEntity.authorizeList).indexOf("search") === -1){
            publicSettingEntity.authorizeList = ["search"];
        }else {
            publicSettingEntity.authorizeList = [];
        }
        publicSettingEntity.authorizeList.forEach( authorizeListItem=> {
            $("input[value='"+authorizeListItem+"']").prop("checked", true);
        })
    }
    function clickDownloadCheckBox(){
        if(!publicSettingEntity.authorizeList || (publicSettingEntity.authorizeList).indexOf("download") === -1){
            publicSettingEntity.authorizeList = ["search","download"];
        }else if((publicSettingEntity.authorizeList).indexOf("search") !== -1){
            publicSettingEntity.authorizeList = ["search"];
        }
        publicSettingEntity.authorizeList.forEach( authorizeListItem=> {
            $("input[value='"+authorizeListItem+"']").prop("checked", true);
        })
    }
    function clickViewCheckBox(){
        if(!publicSettingEntity.authorizeList || (publicSettingEntity.authorizeList).indexOf("view") === -1){
            publicSettingEntity.authorizeList = ["search","view"];
        }else if((publicSettingEntity.authorizeList).indexOf("search") !== -1){
            publicSettingEntity.authorizeList = ["search"];
        }
        publicSettingEntity.authorizeList.forEach( authorizeListItem=> {
            $("input[value='"+authorizeListItem+"']").prop("checked", true);
        })
    }
    function clickEditCheckBox(){
        if(!publicSettingEntity.authorizeList || (publicSettingEntity.authorizeList).indexOf("edit") === -1){
            publicSettingEntity.authorizeList = ["search","view","edit"];
        }else if((publicSettingEntity.authorizeList).indexOf("view") !== -1){
            publicSettingEntity.authorizeList = ["search","view"];
        }
        publicSettingEntity.authorizeList.forEach( authorizeListItem=> {
            $("input[value='"+authorizeListItem+"']").prop("checked", true);
        })
    }
    //根据已有的权限生成authorizeList，用于复选框双向绑定
    function getAuthorizeList(permissionType){
        let authorizeList = [];
        switch(permissionType){
            case "SEARCH":
                authorizeList = ["search"];
                break;
            case "READ":
                authorizeList = ["search","view"];
                break;
            case "DOWNLOAD":
                authorizeList = ["search","download"];
                break;
            case "READWRITE":
                authorizeList = ["search","view","edit"];
                break;
            case "DELETE":
                authorizeList = ["search","view","edit"];
                break;
            default:
                break;
        }
        return authorizeList;
    }
    // 选择资源类型  查询资源
    function onSelectResourcesType(){
        iPortal = new SuperMap.iPortal(iPortalUrl);
        let type = $("#typeSelect").val();
        resourceType = type;
        queryParams = new SuperMap.iPortalQueryParam({
            resourceType: type,
            searchType:'MY_RES',
            pageSize: 15,
            currentPage: 1
        });
        queryResouces(queryParams);
    }
</script>
</body>
</html>